<script>
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const modelSelect = document.getElementById('modelSelect');
const newChatBtn = document.getElementById('newChatBtn');
const themeToggle = document.getElementById("themeToggle");

// Chat history in memory
let chatHistory = []; // removed system message from frontend

function addBubble(text, cls){
  const div = document.createElement('div');
  div.className = `bubble ${cls}`;
  div.textContent = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;

  addBubble(text, 'user');
  inputEl.value = '';

  addBubble('â€¦', 'bot');
  const loadingBubble = messagesEl.lastChild;

  // Add user message to history
  chatHistory.push({ role: "user", content: text });

  try{
    const res = await fetch('https://mini-gpt-backend.vercel.app/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: text, model: modelSelect.value, history: chatHistory })
    });

    const data = await res.json();
    loadingBubble.textContent = data.reply || 'No reply';

    // Add bot message to history
    chatHistory.push({ role: "assistant", content: data.reply || '' });
  }catch(e){
    loadingBubble.textContent = 'Error: ' + e.message;
  }
}

sendBtn.onclick = sendMessage;
inputEl.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// New Chat button
newChatBtn.addEventListener("click", () => {
  messagesEl.innerHTML = '';
  chatHistory = []; // removed system message
  addBubble('Hello! I\'m MiniGPT â€” ask me anything!', 'bot');
});

// Theme toggle
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  if(document.body.classList.contains("dark-mode")){
    themeToggle.textContent = "â˜€ï¸ Light Mode";
  } else {
    themeToggle.textContent = "ğŸŒ™ Dark Mode";
  }
});

// Initial greeting
addBubble('Hello! I\'m MiniGPT â€” ask me anything!', 'bot');
</script>
